# Slopspotter Browser Extension

Slopspotter adds inline risk signals to code snippets generated by AI chat interfaces. It extracts package references, queries the Slopspotter backend for intelligence, and renders color-coded indicators with hover cards that summarize risk, heuristics, and metadata links.

## Getting started

```bash
# Install dependencies
npm install

# Produce a production build in dist/
npm run build

# During development, keep webpack watching
npm run watch
```

To load the extension in Chrome/Edge:

1. Run `npm run build`.
2. Open `chrome://extensions`, enable Developer Mode, and choose **Load unpacked**.
3. Select the `dist/` directory.
4. Install the native messaging host manifest via the Slopspotter CLI, and use the same host name in the popup field.

For Firefox:

1. Run `npm run build`.
2. Visit `about:debugging#/runtime/this-firefox` and click **Load Temporary Add-on**.
3. Choose `dist/manifest.json`.
4. Ensure the native host manifest is registered before attempting to run checks.

## Runtime behavior

- **Content script** (`src/content/contentScript.js`) watches chat-style UIs for `<pre><code>` blocks, parses them with language-specific regexes, and sends package lists to the background service.
- **Background service worker** (`src/background/index.js`) communicates exclusively with the native messaging host (the Python CLI) and falls back to heuristics if the host cannot be reached.
- **Inline indicators** map risk (`high`, `medium`, `low`, `unknown`) to red/yellow/green chips; hovering reveals metadata, confidence scores, and registry links.
- **Popup UI** (`dist/popup.html`) lets you enter the native host ID and toggle automatic analysis of new code appearing in the chat UI.

If the backend is offline, the extension still renders heuristic estimates and displays a warning banner.

## Frontend ↔ Backend contract

The background worker posts JSON payloads shaped like:

```jsonc
{
  "snippetId": "snippet-123",
  "packages": [
    {
      "name": "requests",
      "language": "python",
      "contextSnippet": "import requests"
    }
  ]
}
```

Expected response:

```jsonc
{
  "snippetId": "snippet-123",
  "packages": [
    {
      "name": "requests",
      "language": "python",
      "result": {
        "riskLevel": "low",
        "score": 0.12,
        "summary": "No strong red flags detected.",
        "metadataUrl": "https://pypi.org/project/requests/",
        "signals": {
          "registry": { "score": 0.0, "reason": "Found in registry" },
          "name": { "score": 0.0, "reason": "Benign name" },
          "install": { "score": 0.0, "reason": "No install concerns" },
          "metadata": { "score": 0.0, "reason": "Metadata present" }
        }
      }
    }
  ],
  "warning": "optional warning string"
}
```

The native messaging host must write the JSON response to stdout using the WebExtensions native messaging framing (length prefix + UTF-8 payload).

## Heuristic fallback (frontend)

If the host is unreachable, the background computes a risk score and level:

- Signals: registry existence (PyPI/npm/crates/proxy.golang), popularity/downloads/release count, recency, name risk, install scripts/wheels-only (npm/PyPI), metadata presence (repo/homepage/license), and a Python stdlib allowlist (e.g., `sys`, `math`, `json`, `os`, etc.) forced to low. When the native host is reachable, the same signals are computed server-side in Python and returned via the `signals` object above.
- Scoring: weighted sum → clamp to [0,1] → `riskLevel`: `>= 0.7` high, `>= 0.4` medium, else low.
- Metadata links point to the appropriate registry. Warning banner shown when using heuristics.

## Tests

- Frontend tests use Vitest. Run `npm test`. Current coverage: parser import extraction (aliased imports, relative imports, stdlib handling).
- Backend scoring lives in the native host (Python). Run `python -m pytest test/test_scoring_backend.py` from `slopspotter-cli/` to exercise the signal combinators.

The native host must implement the scoring logic described above; the frontend fallback only runs when the host is unreachable.
